{% extends "base.html" %}

{% block title %}Game de Digitação{% endblock %}

{% block content %}
<div class="container text-center">
    <h1 class="mb-4">Game de Digitação</h1>

    <div id="setup-div">
        <h2>Escolha um Nível de Dificuldade</h2>
        <div class="d-grid gap-2 col-6 mx-auto mt-4">
            <button class="btn btn-lg btn-success btn-dificuldade" data-dificuldade="FACIL">Fácil</button>
            <button class="btn btn-lg btn-warning btn-dificuldade" data-dificuldade="MEDIO">Médio</button>
            <button class="btn btn-lg btn-danger btn-dificuldade" data-dificuldade="DIFICIL">Difícil</button>
        </div>
    </div>

    <div id="game-div" style="display: none;">
        <div id="texto-para-digitar" class="p-3 mb-2 bg-light border rounded fs-4 font-monospace" style="line-height: 1.6; user-select: none;"></div>
        <div class="game-actions my-3">
            <button id="restart-lesson-btn" class="btn btn-secondary">Reiniciar Frase</button>
        </div>
        <div class="stats-bar d-flex justify-content-around p-3 bg-light rounded">
            <div class="stat text-center"><div>Tempo</div><div id="timer" class="fs-2 fw-bold">0s</div></div>
            <div class="stat text-center"><div>Velocidade (PPM)</div><div id="wpm" class="fs-2 fw-bold">0</div></div>
            <div class="stat text-center"><div>Precisão</div><div id="accuracy" class="fs-2 fw-bold">100%</div></div>
        </div>
    </div>

    <div id="resultado-div" style="display: none;">
        <h2>Parabéns, você completou!</h2>
        <p>Seu resultado foi salvo.</p>
        <div id="leaderboard-container" class="mt-4">
            <h3>Placar de Líderes</h3>
            <table id="leaderboard-tabela" class="table w-75 mx-auto"></table>
        </div>
        <button id="play-again-btn" class="btn btn-primary btn-lg mt-3">Jogar Novamente</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');
        const licoesJson = '{{ licoes_json|escapejs }}';
        let licoes = [];
        const licoesAgrupadas = { FACIL: [], MEDIO: [], DIFICIL: [] };
        let licaoAtual;
        let indexAtual = 0, erros = 0, startTime, timerInterval;

        const setupDiv = document.getElementById('setup-div');
        const gameDiv = document.getElementById('game-div');
        const resultadoDiv = document.getElementById('resultado-div');
        const textoParaDigitarEl = document.getElementById('texto-para-digitar');
        const timerEl = document.getElementById('timer');
        const wpmEl = document.getElementById('wpm');
        const accuracyEl = document.getElementById('accuracy');
        const restartLessonBtn = document.getElementById('restart-lesson-btn');
        const playAgainBtn = document.getElementById('play-again-btn');

        try {
            licoes = JSON.parse(licoesJson).map(item => ({ id: item.pk, ...item.fields }));
            licoes.forEach(licao => {
                if (licoesAgrupadas[licao.dificuldade]) {
                    licoesAgrupadas[licao.dificuldade].push(licao);
                }
            });
        } catch (e) {
            document.querySelector('.container').innerHTML = '<h1>Erro Crítico ao Carregar Lições do Jogo.</h1>';
            return;
        }

            function iniciarJogo() {
                setupDiv.style.display = 'none';
                resultadoDiv.style.display = 'none';
                gameDiv.style.display = 'block';

                indexAtual = 0; erros = 0; startTime = null;
                clearInterval(timerInterval);
                timerEl.textContent = '0s';
                wpmEl.textContent = '0';
                accuracyEl.textContent = '100%';

                textoParaDigitarEl.innerHTML = licaoAtual.texto.split('').map(char => `<span>${char}</span>`).join('');
                textoParaDigitarEl.setAttribute('tabindex', '-1'); 
                document.querySelectorAll('#texto-para-digitar span')[0].classList.add('cursor');
                document.addEventListener('keydown', handleKeyPress);
                textoParaDigitarEl.focus(); 

        function handleKeyPress(e) {
            e.preventDefault();
            const charDigitado = e.key;
            if (charDigitado.length > 1 && charDigitado !== 'Backspace') return;
            if (!startTime) { startTime = new Date(); timerInterval = setInterval(atualizarStats, 1000); }
            const spans = document.querySelectorAll('#texto-para-digitar span');
            if (e.key === 'Backspace') {
                if (indexAtual > 0) {
                    spans[indexAtual]?.classList.remove('cursor');
                    indexAtual--;
                    spans[indexAtual].classList.remove('correto', 'incorreto');
                    spans[indexAtual].classList.add('cursor');
                }
                return;
            }
            const spanAtual = spans[indexAtual];
            if (!spanAtual) return;
            if (e.key === spanAtual.textContent) { spanAtual.classList.add('correto'); } else { spanAtual.classList.add('incorreto'); erros++; }
            spanAtual.classList.remove('cursor');
            indexAtual++;
            if (indexAtual < spans.length) { spans[indexAtual].classList.add('cursor'); } else { finalizarJogo(); }
        }

        function atualizarStats() {
            if (!startTime) return;
            const tempoDecorrido = Math.round(((new Date() - startTime) / 1000));
            timerEl.textContent = `${tempoDecorrido}s`;
            const palavrasDigitadas = (indexAtual / 5);
            const minutos = tempoDecorrido / 60;
            const wpm = minutos > 0 ? Math.round(palavrasDigitadas / minutos) : 0;
            wpmEl.textContent = wpm;
            const precisao = indexAtual > 0 ? Math.max(0, ((indexAtual - erros) / indexAtual) * 100) : 100;
            accuracyEl.textContent = `${precisao.toFixed(1)}%`;
        }

        async function finalizarJogo() {
            document.removeEventListener('keydown', handleKeyPress);
            clearInterval(timerInterval);
            atualizarStats();
            
            const postHeaders = { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken };
            try {
                await fetch('/api/digitacao/resultados/', {
                    method: 'POST',
                    headers: postHeaders,
                    body: JSON.stringify({ licao: licaoAtual.id, palavras_por_minuto: parseInt(wpmEl.textContent), precisao: parseFloat(accuracyEl.textContent) })
                });
                const lbResponse = await fetch(`/api/digitacao/licoes/${licaoAtual.id}/leaderboard/`);
                const lbData = await lbResponse.json();
                const tabela = document.getElementById('leaderboard-tabela');
                tabela.innerHTML = '<thead><tr><th>#</th><th>Jogador</th><th>PPM</th><th>Precisão</th></tr></thead><tbody></tbody>';
                const corpoTabela = tabela.querySelector('tbody');
                lbData.forEach((resultado, index) => {
                    corpoTabela.innerHTML += `<tr><td class="fw-bold">${index + 1}</td><td>${resultado.aluno_username}</td><td>${resultado.palavras_por_minuto}</td><td>${resultado.precisao.toFixed(1)}%</td></tr>`;
                });
            } catch(error) { 
                console.error('Falha ao salvar ou buscar resultados:', error);
                document.getElementById('leaderboard-container').innerHTML = '<p class="text-danger">Não foi possível carregar o placar.</p>';
            }
            gameDiv.style.display = 'none';
            resultadoDiv.style.display = 'block';
        }

        document.querySelectorAll('.btn-dificuldade').forEach(button => {
            button.addEventListener('click', () => {

                const dificuldade = button.dataset.dificuldade;
                const licoesDoNivel = licoesAgrupadas[dificuldade];

                console.log("Dificuldade clicada:", dificuldade);
                console.log("Lições encontradas para este nível:", licoesDoNivel);
                
                if (licoesDoNivel && licoesDoNivel.length > 0) {
                    licaoAtual = licoesDoNivel[Math.floor(Math.random() * licoesDoNivel.length)];
                    iniciarJogo();
                } else {
                    alert(`Nenhuma lição encontrada para o nível ${dificuldade}.`);
                }
            });
        });



}

</script>
{% endblock %}